<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="„Çø„Çπ„ÇØÁÆ°ÁêÜ">
    <title>„Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç¢„Éó„É™ - iPhone „Éó„É¨„Éì„É•„ÉºÁâπÂåñÁâà</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            overflow: hidden;
        }
        
        .preview-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .preview-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .preview-pdf {
            width: 95%;
            height: 95%;
            background: white;
            border-radius: 8px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .preview-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .preview-control-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .file-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 18px;
            color: white;
        }
        
        .file-pdf { background: #dc3545; }
        .file-image { background: #28a745; }
        .file-excel { background: #17a2b8; }
        .file-word { background: #007bff; }
        .file-default { background: #6c757d; }
        
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #007bff;
        }
        
        .task-completed .task-card {
            border-left-color: #28a745;
            opacity: 0.7;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            min-height: 48px;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .input-field {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            min-height: 48px;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            outline: none;
        }
        
        .calendar-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px;
            min-height: 44px;
            min-width: 44px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .notification-permission {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            text-align: center;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-drop-zone {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            margin: 16px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone.dragover {
            border-color: #007bff;
            background: rgba(0, 123, 255, 0.05);
        }
        
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .task-card {
                margin: 12px 0;
                padding: 16px;
            }
            
            .preview-controls {
                top: 10px;
                right: 10px;
            }
            
            .preview-control-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 safe-area-top safe-area-bottom">
    <div class="container mx-auto max-w-4xl">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="bg-white shadow-sm rounded-lg p-6 mb-6 mt-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-tasks text-blue-600 mr-3"></i>
                        „Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç¢„Éó„É™
                    </h1>
                    <p class="text-gray-600 text-sm mt-1">Ê†™Âºè‰ºöÁ§æ„Ç¢„Ç§„ÉØ„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞ÊßòÂ∞ÇÁî®</p>
                </div>
                <button id="addTaskBtn" class="btn-primary touch-target">
                    <i class="fas fa-plus mr-2"></i>
                    Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ„ÇíËøΩÂä†
                </button>
            </div>
        </header>

        <!-- ÈÄöÁü•Ë®±ÂèØ -->
        <div id="notificationPermission" class="notification-permission" style="display: none;">
            <p class="mb-3">üìÖ ÊúüÊó•„ÅÆÈÄöÁü•„ÇíÂèó„ÅëÂèñ„Çã„Å´„ÅØ„ÄÅÈÄöÁü•„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
            <button id="enableNotifications" class="btn-primary">ÈÄöÁü•„ÇíË®±ÂèØ</button>
        </div>

        <!-- „Ç§„É≥„Éù„Éº„Éà/„Ç®„ÇØ„Çπ„Éù„Éº„Éà -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="exportBtn" class="btn-secondary touch-target">
                    <i class="fas fa-download mr-2"></i>
                    „Ç®„ÇØ„Çπ„Éù„Éº„Éà
                </button>
                <button id="importBtn" class="btn-secondary touch-target">
                    <i class="fas fa-upload mr-2"></i>
                    „Ç§„É≥„Éù„Éº„Éà
                </button>
                <input type="file" id="importFile" accept=".json,.txt" style="display: none;">
            </div>
        </div>

        <!-- Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„Éº -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="„Çø„Çπ„ÇØ„ÇíÊ§úÁ¥¢..." class="input-field flex-1">
                <select id="filterSelect" class="input-field">
                    <option value="all">„Åô„Åπ„Å¶</option>
                    <option value="pending">Êú™ÂÆå‰∫Ü</option>
                    <option value="completed">ÂÆå‰∫ÜÊ∏à„Åø</option>
                </select>
            </div>
        </div>

        <!-- „Çø„Çπ„ÇØ„É™„Çπ„Éà -->
        <div id="taskList" class="space-y-4">
            <!-- „Çø„Çπ„ÇØ„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
        </div>
    </div>

    <!-- „Çø„Çπ„ÇØËøΩÂä†/Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-xl font-bold">Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="taskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Çø„Çπ„ÇØÂêç</label>
                        <input type="text" id="taskName" class="input-field w-full" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®òÂÖ•Êó•</label>
                        <input type="date" id="entryDate" class="input-field w-full" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áô∫Ê≥®Êó•Ôºà‰æùÈ†ºÊó•Ôºâ</label>
                        <input type="datetime-local" id="orderDate" class="input-field w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‰∏≠ÈñìÁ¢∫Ë™çÊó•</label>
                        <input type="datetime-local" id="checkDate" class="input-field w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÆå‰∫ÜÊó•</label>
                        <input type="datetime-local" id="completeDate" class="input-field w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôËÄÉÊ¨Ñ</label>
                        <textarea id="remarks" class="input-field w-full" rows="3"></textarea>
                    </div>
                    
                    <!-- „Éï„Ç°„Ç§„É´Ê∑ª‰ªò -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">„Éï„Ç°„Ç§„É´Ê∑ª‰ªò</label>
                        <div class="file-drop-zone" id="fileDropZone">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">„Éï„Ç°„Ç§„É´„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</p>
                            <p class="text-sm text-gray-500">„Åæ„Åü„ÅØ</p>
                            <button type="button" class="btn-secondary mt-2" id="selectFileBtn">„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</button>
                        </div>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <div id="fileList" class="mt-4"></div>
                    </div>
                    
                    <div class="flex gap-4 pt-6">
                        <button type="submit" class="btn-primary flex-1">‰øùÂ≠ò</button>
                        <button type="button" id="cancelBtn" class="btn-secondary flex-1">„Ç≠„É£„É≥„Çª„É´</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-controls">
                <div class="preview-control-btn" id="closePreview">
                    <i class="fas fa-times"></i>
                </div>
                <div class="preview-control-btn" id="zoomIn">
                    <i class="fas fa-search-plus"></i>
                </div>
                <div class="preview-control-btn" id="zoomOut">
                    <i class="fas fa-search-minus"></i>
                </div>
                <div class="preview-control-btn" id="resetZoom">
                    <i class="fas fa-expand-arrows-alt"></i>
                </div>
            </div>
            <div id="previewContainer"></div>
        </div>
    </div>

    <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <script>
        class TaskManager {
            constructor() {
                this.tasks = [];
                this.currentTaskId = null;
                this.currentScale = 1;
                this.currentFile = null;
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.isZooming = false;
                
                this.initializeApp();
                this.setupEventListeners();
                this.loadTasks();
                this.checkNotificationPermission();
            }

            initializeApp() {
                // Service Worker registration for PWA
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install", e => e.waitUntil(self.skipWaiting())); self.addEventListener("activate", e => e.waitUntil(self.clients.claim()));')
                        .catch(console.error);
                }
            }

            setupEventListeners() {
                // „É°„Ç§„É≥„Éú„Çø„É≥
                document.getElementById('addTaskBtn').addEventListener('click', () => this.openTaskModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportTasks());
                document.getElementById('importBtn').addEventListener('click', () => this.importTasks());
                document.getElementById('importFile').addEventListener('change', (e) => this.handleFileImport(e));

                // „É¢„Éº„ÉÄ„É´
                document.getElementById('closeModal').addEventListener('click', () => this.closeTaskModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeTaskModal());
                document.getElementById('taskForm').addEventListener('submit', (e) => this.saveTask(e));

                // „Éï„Ç°„Ç§„É´Èñ¢ÈÄ£
                document.getElementById('selectFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelection(e));
                
                const dropZone = document.getElementById('fileDropZone');
                dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
                dropZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                dropZone.addEventListener('drop', (e) => this.handleFileDrop(e));

                // „Éó„É¨„Éì„É•„ÉºÈñ¢ÈÄ£
                document.getElementById('closePreview').addEventListener('click', () => this.closePreview());
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetZoom').addEventListener('click', () => this.resetZoom());

                // Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø„Éº
                document.getElementById('searchInput').addEventListener('input', () => this.filterTasks());
                document.getElementById('filterSelect').addEventListener('change', () => this.filterTasks());

                // ÈÄöÁü•Ë®±ÂèØ
                document.getElementById('enableNotifications').addEventListener('click', () => this.requestNotificationPermission());

                // „Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´„ÅÆ„Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà
                const previewModal = document.getElementById('previewModal');
                previewModal.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                previewModal.addEventListener('touchmove', (e) => this.handleTouchMove(e));
                previewModal.addEventListener('touchend', (e) => this.handleTouchEnd(e));

                // „ÇØ„É™„ÉÉ„ÇØÂ§ñ„Åß„É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
                document.getElementById('taskModal').addEventListener('click', (e) => {
                    if (e.target.id === 'taskModal') this.closeTaskModal();
                });
                previewModal.addEventListener('click', (e) => {
                    if (e.target.id === 'previewModal') this.closePreview();
                });
            }

            loadTasks() {
                const saved = localStorage.getItem('tasks');
                if (saved) {
                    this.tasks = JSON.parse(saved);
                    this.renderTasks();
                    this.setupNotifications();
                }
            }

            saveTasks() {
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                this.setupNotifications();
            }

            openTaskModal(taskId = null) {
                this.currentTaskId = taskId;
                const modal = document.getElementById('taskModal');
                const title = document.getElementById('modalTitle');
                
                if (taskId) {
                    title.textContent = '„Çø„Çπ„ÇØ„ÇíÁ∑®ÈõÜ';
                    this.populateTaskForm(taskId);
                } else {
                    title.textContent = 'Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØ';
                    this.resetTaskForm();
                }
                
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeTaskModal() {
                document.getElementById('taskModal').classList.add('hidden');
                document.body.style.overflow = '';
                this.resetTaskForm();
            }

            resetTaskForm() {
                document.getElementById('taskForm').reset();
                document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('fileList').innerHTML = '';
                this.currentTaskFiles = [];
            }

            populateTaskForm(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;

                document.getElementById('taskName').value = task.name;
                document.getElementById('entryDate').value = task.entryDate;
                document.getElementById('orderDate').value = task.orderDate;
                document.getElementById('checkDate').value = task.checkDate;
                document.getElementById('completeDate').value = task.completeDate;
                document.getElementById('remarks').value = task.remarks;
                
                this.currentTaskFiles = task.files || [];
                this.renderFileList();
            }

            saveTask(e) {
                e.preventDefault();
                
                const taskData = {
                    name: document.getElementById('taskName').value,
                    entryDate: document.getElementById('entryDate').value,
                    orderDate: document.getElementById('orderDate').value,
                    checkDate: document.getElementById('checkDate').value,
                    completeDate: document.getElementById('completeDate').value,
                    remarks: document.getElementById('remarks').value,
                    files: this.currentTaskFiles || [],
                    completed: false
                };

                if (this.currentTaskId) {
                    const taskIndex = this.tasks.findIndex(t => t.id === this.currentTaskId);
                    this.tasks[taskIndex] = { ...this.tasks[taskIndex], ...taskData };
                } else {
                    taskData.id = Date.now();
                    taskData.createdAt = new Date().toISOString();
                    this.tasks.push(taskData);
                }

                this.saveTasks();
                this.renderTasks();
                this.closeTaskModal();
            }

            deleteTask(taskId) {
                if (confirm('„Åì„ÅÆ„Çø„Çπ„ÇØ„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    this.tasks = this.tasks.filter(t => t.id !== taskId);
                    this.saveTasks();
                    this.renderTasks();
                }
            }

            duplicateTask(taskId) {
                const original = this.tasks.find(t => t.id === taskId);
                if (!original) return;

                const duplicate = {
                    ...original,
                    id: Date.now(),
                    name: original.name + ' („Ç≥„Éî„Éº)',
                    createdAt: new Date().toISOString(),
                    completed: false
                };

                this.tasks.push(duplicate);
                this.saveTasks();
                this.renderTasks();
            }

            toggleTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    this.saveTasks();
                    this.renderTasks();
                }
            }

            renderTasks() {
                const container = document.getElementById('taskList');
                const filteredTasks = this.getFilteredTasks();
                
                if (filteredTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-tasks text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">„Çø„Çπ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredTasks.map(task => `
                    <div class="task-card ${task.completed ? 'task-completed' : ''}">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center flex-1">
                                <button onclick="taskManager.toggleTask(${task.id})" class="touch-target mr-3">
                                    <i class="fas ${task.completed ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-400'} text-xl"></i>
                                </button>
                                <h3 class="font-semibold text-lg ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task.name}</h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="taskManager.openTaskModal(${task.id})" class="touch-target text-blue-600">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="taskManager.duplicateTask(${task.id})" class="touch-target text-green-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="taskManager.deleteTask(${task.id})" class="touch-target text-red-600">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-sm">
                            <div><strong>Ë®òÂÖ•Êó•:</strong> ${task.entryDate}</div>
                            <div><strong>Áô∫Ê≥®Êó•:</strong> ${task.orderDate ? this.formatDateTime(task.orderDate) : 'Êú™Ë®≠ÂÆö'}</div>
                            <div><strong>Á¢∫Ë™çÊó•:</strong> ${task.checkDate ? this.formatDateTime(task.checkDate) : 'Êú™Ë®≠ÂÆö'}</div>
                            <div><strong>ÂÆå‰∫ÜÊó•:</strong> ${task.completeDate ? this.formatDateTime(task.completeDate) : 'Êú™Ë®≠ÂÆö'}</div>
                        </div>
                        
                        ${task.remarks ? `<div class="mb-4 p-3 bg-gray-50 rounded"><strong>ÂÇôËÄÉ:</strong> ${task.remarks}</div>` : ''}
                        
                        ${task.files && task.files.length > 0 ? `
                            <div class="mb-4">
                                <strong class="block mb-2">Ê∑ª‰ªò„Éï„Ç°„Ç§„É´:</strong>
                                ${task.files.map(file => `
                                    <div class="file-item" onclick="taskManager.previewFile(${task.id}, '${file.id}')">
                                        <div class="file-icon ${this.getFileIconClass(file.type)}">
                                            <i class="fas ${this.getFileIcon(file.type)}"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">${file.name}</div>
                                            <div class="text-sm text-gray-500">${this.formatFileSize(file.size)}</div>
                                        </div>
                                        <i class="fas fa-eye text-blue-600"></i>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-wrap gap-2">
                            ${task.orderDate ? `<button onclick="taskManager.addToCalendar('${task.name}', '${task.orderDate}', 'Áô∫Ê≥®Êó•')" class="calendar-btn"><i class="fas fa-calendar-plus mr-1"></i>Áô∫Ê≥®Êó•</button>` : ''}
                            ${task.checkDate ? `<button onclick="taskManager.addToCalendar('${task.name}', '${task.checkDate}', '‰∏≠ÈñìÁ¢∫Ë™çÊó•')" class="calendar-btn"><i class="fas fa-calendar-plus mr-1"></i>Á¢∫Ë™çÊó•</button>` : ''}
                            ${task.completeDate ? `<button onclick="taskManager.addToCalendar('${task.name}', '${task.completeDate}', 'ÂÆå‰∫ÜÊó•')" class="calendar-btn"><i class="fas fa-calendar-plus mr-1"></i>ÂÆå‰∫ÜÊó•</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            getFilteredTasks() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filter = document.getElementById('filterSelect').value;
                
                return this.tasks.filter(task => {
                    const matchesSearch = task.name.toLowerCase().includes(searchTerm) ||
                                        task.remarks.toLowerCase().includes(searchTerm);
                    
                    const matchesFilter = filter === 'all' ||
                                        (filter === 'completed' && task.completed) ||
                                        (filter === 'pending' && !task.completed);
                    
                    return matchesSearch && matchesFilter;
                });
            }

            filterTasks() {
                this.renderTasks();
            }

            handleFileSelection(e) {
                const files = Array.from(e.target.files);
                this.processFiles(files);
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('fileDropZone').classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('fileDropZone').classList.remove('dragover');
            }

            handleFileDrop(e) {
                e.preventDefault();
                document.getElementById('fileDropZone').classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                this.processFiles(files);
            }

            processFiles(files) {
                if (!this.currentTaskFiles) {
                    this.currentTaskFiles = [];
                }

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileData = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: e.target.result
                        };
                        this.currentTaskFiles.push(fileData);
                        this.renderFileList();
                    };
                    reader.readAsDataURL(file);
                });
            }

            renderFileList() {
                const container = document.getElementById('fileList');
                if (!this.currentTaskFiles || this.currentTaskFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = this.currentTaskFiles.map(file => `
                    <div class="file-item">
                        <div class="file-icon ${this.getFileIconClass(file.type)}">
                            <i class="fas ${this.getFileIcon(file.type)}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium">${file.name}</div>
                            <div class="text-sm text-gray-500">${this.formatFileSize(file.size)}</div>
                        </div>
                        <button onclick="taskManager.removeFile('${file.id}')" class="text-red-600 hover:text-red-800 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            removeFile(fileId) {
                this.currentTaskFiles = this.currentTaskFiles.filter(f => f.id != fileId);
                this.renderFileList();
            }

            getFileIcon(type) {
                if (type.startsWith('image/')) return 'fa-image';
                if (type === 'application/pdf') return 'fa-file-pdf';
                if (type.includes('excel') || type.includes('spreadsheet')) return 'fa-file-excel';
                if (type.includes('word') || type.includes('document')) return 'fa-file-word';
                return 'fa-file';
            }

            getFileIconClass(type) {
                if (type.startsWith('image/')) return 'file-image';
                if (type === 'application/pdf') return 'file-pdf';
                if (type.includes('excel') || type.includes('spreadsheet')) return 'file-excel';
                if (type.includes('word') || type.includes('document')) return 'file-word';
                return 'file-default';
            }

            previewFile(taskId, fileId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                const file = task.files.find(f => f.id == fileId);
                if (!file) return;

                this.currentFile = file;
                this.currentScale = 1;
                
                const container = document.getElementById('previewContainer');
                const modal = document.getElementById('previewModal');
                
                if (file.type.startsWith('image/')) {
                    container.innerHTML = `<img src="${file.data}" class="preview-image" id="previewImage" alt="${file.name}">`;
                } else if (file.type === 'application/pdf') {
                    this.renderPDF(file, container);
                } else if (file.type.includes('text/')) {
                    this.renderText(file, container);
                } else {
                    container.innerHTML = `
                        <div class="text-center text-white p-8">
                            <i class="fas fa-file text-6xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                            <p class="text-gray-300">„Éó„É¨„Éì„É•„Éº„Åß„Åç„Å™„ÅÑ„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô</p>
                            <p class="text-sm text-gray-400 mt-2">„Çµ„Ç§„Ç∫: ${this.formatFileSize(file.size)}</p>
                        </div>
                    `;
                }
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            renderPDF(file, container) {
                // Á∞°ÊòìPDF„Éó„É¨„Éì„É•„ÉºÔºàÂÆüÈöõ„ÅÆPDFË°®Á§∫„ÅØÂà∂Èôê„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅÊÉÖÂ†±Ë°®Á§∫Ôºâ
                container.innerHTML = `
                    <div class="preview-pdf">
                        <div class="p-6 text-center">
                            <i class="fas fa-file-pdf text-6xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                            <p class="text-gray-600 mb-4">PDF „Éï„Ç°„Ç§„É´</p>
                            <p class="text-sm text-gray-500">„Çµ„Ç§„Ç∫: ${this.formatFileSize(file.size)}</p>
                            <div class="mt-6">
                                <p class="text-gray-700">„Åì„ÅÆPDF„Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åô„Çã„Å´„ÅØ„ÄÅ</p>
                                <p class="text-gray-700">„Éá„Éê„Ç§„Çπ„ÅÆÊ®ôÊ∫ñPDF„Éì„É•„Éº„Ç¢„Éº„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderText(file, container) {
                // Base64„Åã„Çâ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊäΩÂá∫
                try {
                    const text = atob(file.data.split(',')[1]);
                    container.innerHTML = `
                        <div class="preview-pdf">
                            <div class="p-6">
                                <h3 class="text-lg font-bold mb-4">${file.name}</h3>
                                <pre class="text-sm whitespace-pre-wrap overflow-auto max-h-96">${text}</pre>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('Text parsing error:', e);
                    container.innerHTML = `
                        <div class="text-center text-white p-8">
                            <i class="fas fa-file-alt text-6xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                            <p class="text-gray-300">„ÉÜ„Ç≠„Çπ„Éà„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
                        </div>
                    `;
                }
            }

            closePreview() {
                document.getElementById('previewModal').style.display = 'none';
                document.body.style.overflow = '';
                this.currentFile = null;
                this.currentScale = 1;
            }

            zoomIn() {
                this.currentScale = Math.min(this.currentScale * 1.2, 5);
                this.applyZoom();
            }

            zoomOut() {
                this.currentScale = Math.max(this.currentScale / 1.2, 0.1);
                this.applyZoom();
            }

            resetZoom() {
                this.currentScale = 1;
                this.applyZoom();
            }

            applyZoom() {
                const image = document.getElementById('previewImage');
                if (image) {
                    image.style.transform = `scale(${this.currentScale})`;
                }
            }

            // „Çø„ÉÉ„ÉÅ„Ç∏„Çß„Çπ„ÉÅ„É£„Éº„Ç§„Éô„É≥„Éà
            handleTouchStart(e) {
                if (e.touches.length === 1) {
                    this.touchStartX = e.touches[0].clientX;
                    this.touchStartY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    this.isZooming = true;
                    this.initialDistance = this.getDistance(e.touches[0], e.touches[1]);
                    this.initialScale = this.currentScale;
                }
            }

            handleTouchMove(e) {
                if (this.isZooming && e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = this.getDistance(e.touches[0], e.touches[1]);
                    const scale = (currentDistance / this.initialDistance) * this.initialScale;
                    this.currentScale = Math.max(0.1, Math.min(5, scale));
                    this.applyZoom();
                }
            }

            handleTouchEnd(e) {
                if (e.touches.length === 0) {
                    this.isZooming = false;
                }
            }

            getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            addToCalendar(title, dateTime, type) {
                const date = new Date(dateTime);
                const startDate = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const endDate = new Date(date.getTime() + 60 * 60 * 1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title + ' - ' + type)}&dates=${startDate}/${endDate}&details=${encodeURIComponent('„Çø„Çπ„ÇØÁÆ°ÁêÜ„Ç¢„Éó„É™„Åã„ÇâËøΩÂä†„Åï„Çå„Åæ„Åó„Åü')}`;
                
                window.open(googleUrl, '_blank');
            }

            exportTasks() {
                const dataStr = JSON.stringify(this.tasks, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `tasks_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            importTasks() {
                document.getElementById('importFile').click();
            }

            handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        let content = event.target.result;
                        
                        // JSON„Åæ„Åü„ÅØJSON.TXT„Éï„Ç°„Ç§„É´„ÅÆÂá¶ÁêÜ
                        if (file.name.endsWith('.json.txt') || file.name.endsWith('.txt')) {
                            // „ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å®„Åó„Å¶Ë™≠„ÅøËæº„Åø„ÄÅJSONÈÉ®ÂàÜ„ÇíÊäΩÂá∫
                            const jsonMatch = content.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                content = jsonMatch[0];
                            }
                        }
                        
                        const importedData = JSON.parse(content);
                        
                        if (importedData.tasks && Array.isArray(importedData.tasks)) {
                            if (confirm('Êó¢Â≠ò„ÅÆ„Çø„Çπ„ÇØ„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºüÔºà„Ç≠„É£„É≥„Çª„É´„Åß‰∏äÊõ∏„ÅçÔºâ')) {
                                this.tasks = [...this.tasks, ...importedData.tasks];
                            } else {
                                this.tasks = importedData.tasks;
                            }
                        } else if (Array.isArray(importedData)) {
                            if (confirm('Êó¢Â≠ò„ÅÆ„Çø„Çπ„ÇØ„Å´ËøΩÂä†„Åó„Åæ„Åô„ÅãÔºüÔºà„Ç≠„É£„É≥„Çª„É´„Åß‰∏äÊõ∏„ÅçÔºâ')) {
                                this.tasks = [...this.tasks, ...importedData];
                            } else {
                                this.tasks = importedData;
                            }
                        } else {
                            throw new Error('ÁÑ°Âäπ„Å™„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Åß„Åô');
                        }
                        
                        this.saveTasks();
                        this.renderTasks();
                        alert('„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊúâÂäπ„Å™JSON„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n\n„Ç®„É©„ÉºË©≥Á¥∞: ' + error.message);
                    }
                };
                
                reader.onerror = () => {
                    alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ');
                };
                
                reader.readAsText(file, 'UTF-8');
            }

            checkNotificationPermission() {
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        document.getElementById('notificationPermission').style.display = 'block';
                    }
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            document.getElementById('notificationPermission').style.display = 'none';
                            this.setupNotifications();
                        }
                    });
                }
            }

            setupNotifications() {
                if ('Notification' in window && Notification.permission === 'granted') {
                    this.tasks.forEach(task => {
                        if (!task.completed) {
                            [task.orderDate, task.checkDate, task.completeDate].forEach(date => {
                                if (date) {
                                    this.scheduleNotification(task, date);
                                }
                            });
                        }
                    });
                }
            }

            scheduleNotification(task, dateTime) {
                const notificationTime = new Date(dateTime).getTime() - Date.now();
                if (notificationTime > 0) {
                    setTimeout(() => {
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification(`üìã ${task.name}`, {
                                body: 'ÊúüÊó•„ÅåËøë„Å•„ÅÑ„Å¶„ÅÑ„Åæ„Åô„ÄÇÂøò„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÅãÔºü',
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">üìã</text></svg>'
                            });
                        }
                    }, notificationTime);
                }
            }

            formatDateTime(dateTime) {
                const date = new Date(dateTime);
                return date.toLocaleString('ja-JP');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        const taskManager = new TaskManager();
    </script>
</body>
</html>
