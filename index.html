<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ã‚¿ã‚¹ã‚¯ç®¡ç†">
    <title>ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒª - iPhone ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç‰¹åŒ–ç‰ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
        
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            overflow: hidden;
        }
        
        .preview-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .preview-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }
        
        .preview-pdf {
            width: 95%;
            height: 95%;
            background: white;
            border-radius: 8px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .preview-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .preview-control-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .preview-control-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        
        .file-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 18px;
            color: white;
        }
        
        .file-pdf { background: #dc3545; }
        .file-image { background: #28a745; }
        .file-excel { background: #17a2b8; }
        .file-word { background: #007bff; }
        .file-default { background: #6c757d; }
        
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #007bff;
        }
        
        .task-completed .task-card {
            border-left-color: #28a745;
            opacity: 0.7;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            color: white;
            font-weight: 600;
            min-height: 48px;
            touch-action: manipulation;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        .input-field {
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            min-height: 48px;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            outline: none;
        }
        
        .calendar-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 4px;
            min-height: 44px;
            min-width: 44px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .notification-permission {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            padding: 12px;
            margin: 16px 0;
            text-align: center;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-drop-zone {
            border: 2px dashed #ced4da;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            margin: 16px 0;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone.dragover {
            border-color: #007bff;
            background: rgba(0, 123, 255, 0.05);
        }
        
        .safe-area-top {
            padding-top: env(safe-area-inset-top);
        }
        
        .safe-area-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .task-card {
                margin: 12px 0;
                padding: 16px;
            }
            
            .preview-controls {
                top: 10px;
                right: 10px;
            }
            
            .preview-control-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 safe-area-top safe-area-bottom">
    <div class="container mx-auto max-w-4xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-white shadow-sm rounded-lg p-6 mb-6 mt-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-tasks text-blue-600 mr-3"></i>
                        ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒª
                    </h1>
                    <p class="text-gray-600 text-sm mt-1">æ ªå¼ä¼šç¤¾ã‚¢ã‚¤ãƒ¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°æ§˜å°‚ç”¨</p>
                </div>
                <button id="addTaskBtn" class="btn-primary touch-target">
                    <i class="fas fa-plus mr-2"></i>
                    æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
                </button>
            </div>
        </header>

        <!-- é€šçŸ¥è¨±å¯ -->
        <div id="notificationPermission" class="notification-permission" style="display: none;">
            <p class="mb-3">ğŸ“… æœŸæ—¥ã®é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯ã€é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„</p>
            <button id="enableNotifications" class="btn-primary">é€šçŸ¥ã‚’è¨±å¯</button>
        </div>

        <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <div class="flex flex-wrap gap-4 justify-center">
                <button id="exportBtn" class="btn-secondary touch-target">
                    <i class="fas fa-download mr-2"></i>
                    ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
                <button id="importBtn" class="btn-secondary touch-target">
                    <i class="fas fa-upload mr-2"></i>
                    ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </button>
                <input type="file" id="importFile" accept=".json,.txt" style="display: none;">
            </div>
        </div>

        <!-- æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="bg-white rounded-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4">
                <input type="text" id="searchInput" placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." class="input-field flex-1">
                <select id="filterSelect" class="input-field">
                    <option value="all">ã™ã¹ã¦</option>
                    <option value="pending">æœªå®Œäº†</option>
                    <option value="completed">å®Œäº†æ¸ˆã¿</option>
                </select>
            </div>
        </div>

        <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
        <div id="taskList" class="space-y-4">
            <!-- ã‚¿ã‚¹ã‚¯ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯è¿½åŠ /ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-md w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-xl font-bold">æ–°ã—ã„ã‚¿ã‚¹ã‚¯</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="taskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ã‚¿ã‚¹ã‚¯å</label>
                        <input type="text" id="taskName" class="input-field w-full" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨˜å…¥æ—¥</label>
                        <input type="date" id="entryDate" class="input-field w-full" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç™ºæ³¨æ—¥ï¼ˆä¾é ¼æ—¥ï¼‰</label>
                        <input type="datetime-local" id="orderDate" class="input-field w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ä¸­é–“ç¢ºèªæ—¥</label>
                        <input type="datetime-local" id="checkDate" class="input-field w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å®Œäº†æ—¥</label>
                        <input type="datetime-local" id="completeDate" class="input-field w-full">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è€ƒæ¬„</label>
                        <textarea id="remarks" class="input-field w-full" rows="3"></textarea>
                    </div>
                    
                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜</label>
                        <div class="file-drop-zone" id="fileDropZone">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                            <p class="text-sm text-gray-500">ã¾ãŸã¯</p>
                            <button type="button" class="btn-secondary mt-2" id="selectFileBtn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                        </div>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <div id="fileList" class="mt-4"></div>
                    </div>
                    
                    <div class="flex gap-4 pt-6">
                        <button type="submit" class="btn-primary flex-1">ä¿å­˜</button>
                        <button type="button" id="cancelBtn" class="btn-secondary flex-1">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-content">
            <div class="preview-controls">
                <div class="preview-control-btn" id="closePreview">
                    <i class="fas fa-times"></i>
                </div>
                <div class="preview-control-btn" id="zoomIn">
                    <i class="fas fa-search-plus"></i>
                </div>
                <div class="preview-control-btn" id="zoomOut">
                    <i class="fas fa-search-minus"></i>
                </div>
                <div class="preview-control-btn" id="resetZoom">
                    <i class="fas fa-expand-arrows-alt"></i>
                </div>
            </div>
            <div id="previewContainer"></div>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <script>
        class TaskManager {
            constructor() {
                this.tasks = [];
                this.currentTaskId = null;
                this.currentScale = 1;
                this.currentFile = null;
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.isZooming = false;
                
                this.initializeApp();
                this.setupEventListeners();
                this.loadTasks();
                this.checkNotificationPermission();
            }

            initializeApp() {
                // Service Worker registration for PWA
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install", e => e.waitUntil(self.skipWaiting())); self.addEventListener("activate", e => e.waitUntil(self.clients.claim()));')
                        .catch(console.error);
                }
            }

            setupEventListeners() {
                // ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³
                document.getElementById('addTaskBtn').addEventListener('click', () => this.openTaskModal());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportTasks());
                document.getElementById('importBtn').addEventListener('click', () => this.importTasks());
                document.getElementById('importFile').addEventListener('change', (e) => this.handleFileImport(e));

                // ãƒ¢ãƒ¼ãƒ€ãƒ«
                document.getElementById('closeModal').addEventListener('click', () => this.closeTaskModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeTaskModal());
                document.getElementById('taskForm').addEventListener('submit', (e) => this.saveTask(e));

                // ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£
                document.getElementById('selectFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelection(e));
                
                const dropZone = document.getElementById('fileDropZone');
                dropZone.addEventListener('dragover', (e) => this.handleDragOver(e));
                dropZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                dropZone.addEventListener('drop', (e) => this.handleFileDrop(e));

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£
                document.getElementById('closePreview').addEventListener('click', () => this.closePreview());
                document.getElementById('zoomIn').addEventListener('click', () => this.zoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.zoomOut());
                document.getElementById('resetZoom').addEventListener('click', () => this.resetZoom());

                // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                document.getElementById('searchInput').addEventListener('input', () => this.filterTasks());
                document.getElementById('filterSelect').addEventListener('change', () => this.filterTasks());

                // é€šçŸ¥è¨±å¯
                document.getElementById('enableNotifications').addEventListener('click', () => this.requestNotificationPermission());

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
                const previewModal = document.getElementById('previewModal');
                previewModal.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                previewModal.addEventListener('touchmove', (e) => this.handleTouchMove(e));
                previewModal.addEventListener('touchend', (e) => this.handleTouchEnd(e));

                // ã‚¯ãƒªãƒƒã‚¯å¤–ã§ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
                document.getElementById('taskModal').addEventListener('click', (e) => {
                    if (e.target.id === 'taskModal') this.closeTaskModal();
                });
                previewModal.addEventListener('click', (e) => {
                    if (e.target.id === 'previewModal') this.closePreview();
                });
            }

            loadTasks() {
                const saved = localStorage.getItem('tasks');
                if (saved) {
                    this.tasks = JSON.parse(saved);
                    this.renderTasks();
                    this.setupNotifications();
                }
            }

            saveTasks() {
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                this.setupNotifications();
            }

            openTaskModal(taskId = null) {
                this.currentTaskId = taskId;
                const modal = document.getElementById('taskModal');
                const title = document.getElementById('modalTitle');
                
                if (taskId) {
                    title.textContent = 'ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†';
                    this.populateTaskForm(taskId);
                } else {
                    title.textContent = 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
                    this.resetTaskForm();
                }
                
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            closeTaskModal() {
                document.getElementById('taskModal').classList.add('hidden');
                document.body.style.overflow = '';
                this.resetTaskForm();
            }

            resetTaskForm() {
                document.getElementById('taskForm').reset();
                document.getElementById('entryDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('fileList').innerHTML = '';
                this.currentTaskFiles = [];
            }

            populateTaskForm(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;

                document.getElementById('taskName').value = task.name;
                document.getElementById('entryDate').value = task.entryDate;
                document.getElementById('orderDate').value = task.orderDate;
                document.getElementById('checkDate').value = task.checkDate;
                document.getElementById('completeDate').value = task.completeDate;
                document.getElementById('remarks').value = task.remarks;
                
                this.currentTaskFiles = task.files || [];
                this.renderFileList();
            }

            saveTask(e) {
                e.preventDefault();
                
                const taskData = {
                    name: document.getElementById('taskName').value,
                    entryDate: document.getElementById('entryDate').value,
                    orderDate: document.getElementById('orderDate').value,
                    checkDate: document.getElementById('checkDate').value,
                    completeDate: document.getElementById('completeDate').value,
                    remarks: document.getElementById('remarks').value,
                    files: this.currentTaskFiles || [],
                    completed: false
                };

                if (this.currentTaskId) {
                    const taskIndex = this.tasks.findIndex(t => t.id === this.currentTaskId);
                    this.tasks[taskIndex] = { ...this.tasks[taskIndex], ...taskData };
                } else {
                    taskData.id = Date.now();
                    taskData.createdAt = new Date().toISOString();
                    this.tasks.push(taskData);
                }

                this.saveTasks();
                this.renderTasks();
                this.closeTaskModal();
            }

            deleteTask(taskId) {
                if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.tasks = this.tasks.filter(t => t.id !== taskId);
                    this.saveTasks();
                    this.renderTasks();
                }
            }

            duplicateTask(taskId) {
                const original = this.tasks.find(t => t.id === taskId);
                if (!original) return;

                const duplicate = {
                    ...original,
                    id: Date.now(),
                    name: original.name + ' (ã‚³ãƒ”ãƒ¼)',
                    createdAt: new Date().toISOString(),
                    completed: false
                };

                this.tasks.push(duplicate);
                this.saveTasks();
                this.renderTasks();
            }

            toggleTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    this.saveTasks();
                    this.renderTasks();
                }
            }

            renderTasks() {
                const container = document.getElementById('taskList');
                const filteredTasks = this.getFilteredTasks();
                
                if (filteredTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-tasks text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = filteredTasks.map(task => `
                    <div class="task-card ${task.completed ? 'task-completed' : ''}">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center flex-1">
                                <button onclick="taskManager.toggleTask(${task.id})" class="touch-target mr-3">
                                    <i class="fas ${task.completed ? 'fa-check-circle text-green-500' : 'fa-circle text-gray-400'} text-xl"></i>
                                </button>
                                <h3 class="font-semibold text-lg ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${task.name}</h3>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="taskManager.openTaskModal(${task.id})" class="touch-target text-blue-600">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="taskManager.duplicateTask(${task.id})" class="touch-target text-green-600">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="taskManager.deleteTask(${task.id})" class="touch-target text-red-600">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4 text-sm">
                            <div><strong>è¨˜å…¥æ—¥:</strong> ${task.entryDate}</div>
                            <div><strong>ç™ºæ³¨æ—¥:</strong> ${task.orderDate ? this.formatDateTime(task.orderDate) : 'æœªè¨­å®š'}</div>
                            <div><strong>ç¢ºèªæ—¥:</strong> ${task.checkDate ? this.formatDateTime(task.checkDate) : 'æœªè¨­å®š'}</div>
                            <div><strong>å®Œäº†æ—¥:</strong> ${task.completeDate ? this.formatDateTime(task.completeDate) : 'æœªè¨­å®š'}</div>
                        </div>
                        
                        ${task.remarks ? `<div class="mb-4 p-3 bg-gray-50 rounded"><strong>å‚™è€ƒ:</strong> ${task.remarks}</div>` : ''}
                        
                        ${task.files && task.files.length > 0 ? `
                            <div class="mb-4">
                                <strong class="block mb-2">æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«:</strong>
                                ${task.files.map(file => `
                                    <div class="file-item" onclick="taskManager.previewFile(${task.id}, '${file.id}')">
                                        <div class="file-icon ${this.getFileIconClass(file.type)}">
                                            <i class="fas ${this.getFileIcon(file.type)}"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">${file.name}</div>
                                            <div class="text-sm text-gray-500">${this.formatFileSize(file.size)}</div>
                                        </div>
                                        <i class="fas fa-eye text-blue-600"></i>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="flex flex-wrap gap-2">
                            ${task.orderDate ? `<button onclick="taskManager.addToCalendar('${task.name}', '${task.orderDate}', 'ç™ºæ³¨æ—¥')" class="calendar-btn"><i class="fas fa-calendar-plus mr-1"></i>ç™ºæ³¨æ—¥</button>` : ''}
                            ${task.checkDate ? `<button onclick="taskManager.addToCalendar('${task.name}', '${task.checkDate}', 'ä¸­é–“ç¢ºèªæ—¥')" class="calendar-btn"><i class="fas fa-calendar-plus mr-1"></i>ç¢ºèªæ—¥</button>` : ''}
                            ${task.completeDate ? `<button onclick="taskManager.addToCalendar('${task.name}', '${task.completeDate}', 'å®Œäº†æ—¥')" class="calendar-btn"><i class="fas fa-calendar-plus mr-1"></i>å®Œäº†æ—¥</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }

            getFilteredTasks() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const filter = document.getElementById('filterSelect').value;
                
                return this.tasks.filter(task => {
                    const matchesSearch = task.name.toLowerCase().includes(searchTerm) ||
                                        task.remarks.toLowerCase().includes(searchTerm);
                    
                    const matchesFilter = filter === 'all' ||
                                        (filter === 'completed' && task.completed) ||
                                        (filter === 'pending' && !task.completed);
                    
                    return matchesSearch && matchesFilter;
                });
            }

            filterTasks() {
                this.renderTasks();
            }

            handleFileSelection(e) {
                const files = Array.from(e.target.files);
                this.processFiles(files);
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('fileDropZone').classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('fileDropZone').classList.remove('dragover');
            }

            handleFileDrop(e) {
                e.preventDefault();
                document.getElementById('fileDropZone').classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                this.processFiles(files);
            }

            processFiles(files) {
                if (!this.currentTaskFiles) {
                    this.currentTaskFiles = [];
                }

                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileData = {
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            data: e.target.result
                        };
                        this.currentTaskFiles.push(fileData);
                        this.renderFileList();
                    };
                    reader.readAsDataURL(file);
                });
            }

            renderFileList() {
                const container = document.getElementById('fileList');
                if (!this.currentTaskFiles || this.currentTaskFiles.length === 0) {
                    container.innerHTML = '';
                    return;
                }

                container.innerHTML = this.currentTaskFiles.map(file => `
                    <div class="file-item">
                        <div class="file-icon ${this.getFileIconClass(file.type)}">
                            <i class="fas ${this.getFileIcon(file.type)}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-medium">${file.name}</div>
                            <div class="text-sm text-gray-500">${this.formatFileSize(file.size)}</div>
                        </div>
                        <button onclick="taskManager.removeFile('${file.id}')" class="text-red-600 hover:text-red-800 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }

            removeFile(fileId) {
                this.currentTaskFiles = this.currentTaskFiles.filter(f => f.id != fileId);
                this.renderFileList();
            }

            getFileIcon(type) {
                if (type.startsWith('image/')) return 'fa-image';
                if (type === 'application/pdf') return 'fa-file-pdf';
                if (type.includes('excel') || type.includes('spreadsheet')) return 'fa-file-excel';
                if (type.includes('word') || type.includes('document')) return 'fa-file-word';
                return 'fa-file';
            }

            getFileIconClass(type) {
                if (type.startsWith('image/')) return 'file-image';
                if (type === 'application/pdf') return 'file-pdf';
                if (type.includes('excel') || type.includes('spreadsheet')) return 'file-excel';
                if (type.includes('word') || type.includes('document')) return 'file-word';
                return 'file-default';
            }

            previewFile(taskId, fileId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                const file = task.files.find(f => f.id == fileId);
                if (!file) return;

                this.currentFile = file;
                this.currentScale = 1;
                
                const container = document.getElementById('previewContainer');
                const modal = document.getElementById('previewModal');
                
                if (file.type.startsWith('image/')) {
                    container.innerHTML = `<img src="${file.data}" class="preview-image" id="previewImage" alt="${file.name}">`;
                } else if (file.type === 'application/pdf') {
                    this.renderPDF(file, container);
                } else if (file.type.includes('text/')) {
                    this.renderText(file, container);
                } else {
                    container.innerHTML = `
                        <div class="text-center text-white p-8">
                            <i class="fas fa-file text-6xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                            <p class="text-gray-300">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ããªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™</p>
                            <p class="text-sm text-gray-400 mt-2">ã‚µã‚¤ã‚º: ${this.formatFileSize(file.size)}</p>
                        </div>
                    `;
                }
                
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            renderPDF(file, container) {
                // ç°¡æ˜“PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆå®Ÿéš›ã®PDFè¡¨ç¤ºã¯åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€æƒ…å ±è¡¨ç¤ºï¼‰
                container.innerHTML = `
                    <div class="preview-pdf">
                        <div class="p-6 text-center">
                            <i class="fas fa-file-pdf text-6xl text-red-500 mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                            <p class="text-gray-600 mb-4">PDF ãƒ•ã‚¡ã‚¤ãƒ«</p>
                            <p class="text-sm text-gray-500">ã‚µã‚¤ã‚º: ${this.formatFileSize(file.size)}</p>
                            <div class="mt-6">
                                <p class="text-gray-700">ã“ã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€</p>
                                <p class="text-gray-700">ãƒ‡ãƒã‚¤ã‚¹ã®æ¨™æº–PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderText(file, container) {
                // Base64ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
                try {
                    const text = atob(file.data.split(',')[1]);
                    container.innerHTML = `
                        <div class="preview-pdf">
                            <div class="p-6">
                                <h3 class="text-lg font-bold mb-4">${file.name}</h3>
                                <pre class="text-sm whitespace-pre-wrap overflow-auto max-h-96">${text}</pre>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('Text parsing error:', e);
                    container.innerHTML = `
                        <div class="text-center text-white p-8">
                            <i class="fas fa-file-alt text-6xl mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">${file.name}</h3>
                            <p class="text-gray-300">ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>
                        </div>
                    `;
                }
            }

            closePreview() {
                document.getElementById('previewModal').style.display = 'none';
                document.body.style.overflow = '';
                this.currentFile = null;
                this.currentScale = 1;
            }

            zoomIn() {
                this.currentScale = Math.min(this.currentScale * 1.2, 5);
                this.applyZoom();
            }

            zoomOut() {
                this.currentScale = Math.max(this.currentScale / 1.2, 0.1);
                this.applyZoom();
            }

            resetZoom() {
                this.currentScale = 1;
                this.applyZoom();
            }

            applyZoom() {
                const image = document.getElementById('previewImage');
                if (image) {
                    image.style.transform = `scale(${this.currentScale})`;
                }
            }

            // ã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
            handleTouchStart(e) {
                if (e.touches.length === 1) {
                    this.touchStartX = e.touches[0].clientX;
                    this.touchStartY = e.touches[0].clientY;
                } else if (e.touches.length === 2) {
                    this.isZooming = true;
                    this.initialDistance = this.getDistance(e.touches[0], e.touches[1]);
                    this.initialScale = this.currentScale;
                }
            }

            handleTouchMove(e) {
                if (this.isZooming && e.touches.length === 2) {
                    e.preventDefault();
                    const currentDistance = this.getDistance(e.touches[0], e.touches[1]);
                    const scale = (currentDistance / this.initialDistance) * this.initialScale;
                    this.currentScale = Math.max(0.1, Math.min(5, scale));
                    this.applyZoom();
                }
            }

            handleTouchEnd(e) {
                if (e.touches.length === 0) {
                    this.isZooming = false;
                }
            }

            getDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            addToCalendar(title, dateTime, type) {
                const date = new Date(dateTime);
                const startDate = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const endDate = new Date(date.getTime() + 60 * 60 * 1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                
                const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title + ' - ' + type)}&dates=${startDate}/${endDate}&details=${encodeURIComponent('ã‚¿ã‚¹ã‚¯ç®¡ç†ã‚¢ãƒ—ãƒªã‹ã‚‰è¿½åŠ ã•ã‚Œã¾ã—ãŸ')}`;
                
                window.open(googleUrl, '_blank');
            }

            exportTasks() {
                const dataStr = JSON.stringify(this.tasks, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `tasks_backup_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            importTasks() {
                document.getElementById('importFile').click();
            }

            handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        let content = event.target.result;
                        
                        // JSONã¾ãŸã¯JSON.TXTãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
                        if (file.name.endsWith('.json.txt') || file.name.endsWith('.txt')) {
                            // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦èª­ã¿è¾¼ã¿ã€JSONéƒ¨åˆ†ã‚’æŠ½å‡º
                            const jsonMatch = content.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                content = jsonMatch[0];
                            }
                        }
                        
                        const importedData = JSON.parse(content);
                        
                        if (importedData.tasks && Array.isArray(importedData.tasks)) {
                            if (confirm('æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ä¸Šæ›¸ãï¼‰')) {
                                this.tasks = [...this.tasks, ...importedData.tasks];
                            } else {
                                this.tasks = importedData.tasks;
                            }
                        } else if (Array.isArray(importedData)) {
                            if (confirm('æ—¢å­˜ã®ã‚¿ã‚¹ã‚¯ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§ä¸Šæ›¸ãï¼‰')) {
                                this.tasks = [...this.tasks, ...importedData];
                            } else {
                                this.tasks = importedData;
                            }
                        } else {
                            throw new Error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                        }
                        
                        this.saveTasks();
                        this.renderTasks();
                        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚æœ‰åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼è©³ç´°: ' + error.message);
                    }
                };
                
                reader.onerror = () => {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                };
                
                reader.readAsText(file, 'UTF-8');
            }

            checkNotificationPermission() {
                if ('Notification' in window) {
                    if (Notification.permission === 'default') {
                        document.getElementById('notificationPermission').style.display = 'block';
                    }
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            document.getElementById('notificationPermission').style.display = 'none';
                            this.setupNotifications();
                        }
                    });
                }
            }

            setupNotifications() {
                if ('Notification' in window && Notification.permission === 'granted') {
                    this.tasks.forEach(task => {
                        if (!task.completed) {
                            [task.orderDate, task.checkDate, task.completeDate].forEach(date => {
                                if (date) {
                                    this.scheduleNotification(task, date);
                                }
                            });
                        }
                    });
                }
            }

            scheduleNotification(task, dateTime) {
                const notificationTime = new Date(dateTime).getTime() - Date.now();
                if (notificationTime > 0) {
                    setTimeout(() => {
                        if ('Notification' in window && Notification.permission === 'granted') {
                            new Notification(`ğŸ“‹ ${task.name}`, {
                                body: 'æœŸæ—¥ãŒè¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚å¿˜ã‚Œã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ',
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" font-size="50">ğŸ“‹</text></svg>'
                            });
                        }
                    }, notificationTime);
                }
            }

            formatDateTime(dateTime) {
                const date = new Date(dateTime);
                return date.toLocaleString('ja-JP');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        const taskManager = new TaskManager();
    </script>
</body>
</html>
