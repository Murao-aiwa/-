<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タスク管理アプリ - ファイルプレビュー修正版</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .task-item {
            transition: all 0.3s ease;
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .file-preview-modal {
            backdrop-filter: blur(10px);
        }
        .editable:hover {
            background-color: #f3f4f6;
            cursor: pointer;
        }
        .editing {
            background-color: #dbeafe;
            border: 2px solid #3b82f6;
        }
        .notification-permission {
            animation: pulse 2s infinite;
        }
        .file-item {
            transition: all 0.2s ease;
        }
        .file-item:hover {
            background-color: #f9fafb;
            transform: scale(1.02);
        }
        .calendar-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .calendar-button:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .image-container {
            position: relative;
            overflow: hidden;
        }
        .zoomable-image {
            transition: transform 0.3s ease;
            cursor: grab;
        }
        .zoomable-image:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-tasks text-blue-600 mr-2"></i>
                        タスク管理アプリ
                    </h1>
                    <p class="text-gray-600">株式会社アイワエンジニアリング様専用</p>
                </div>
                <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                    <button onclick="requestNotificationPermission()" id="notificationBtn" class="notification-permission bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-bell mr-2"></i>通知を有効にする
                    </button>
                    <button onclick="showAddTaskModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>新しいタスクを追加
                    </button>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex flex-wrap gap-2 justify-between items-center">
                <div class="flex flex-wrap gap-2">
                    <button onclick="filterTasks('all')" id="filterAll" class="px-4 py-2 rounded bg-blue-600 text-white">
                        <i class="fas fa-list mr-1"></i>すべて
                    </button>
                    <button onclick="filterTasks('pending')" id="filterPending" class="px-4 py-2 rounded bg-gray-300 text-gray-700">
                        <i class="fas fa-clock mr-1"></i>未完了
                    </button>
                    <button onclick="filterTasks('completed')" id="filterCompleted" class="px-4 py-2 rounded bg-gray-300 text-gray-700">
                        <i class="fas fa-check mr-1"></i>完了済み
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    <input type="text" id="searchInput" placeholder="タスクを検索..." class="px-3 py-2 border rounded-lg">
                    <button onclick="exportData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-download mr-2"></i>エクスポート
                    </button>
                    <label class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg cursor-pointer">
                        <i class="fas fa-upload mr-2"></i>インポート
                        <input type="file" accept=".json,.txt" onchange="importData(event)" class="hidden">
                    </label>
                </div>
            </div>
        </div>

        <!-- Tasks List -->
        <div id="tasksList" class="space-y-4">
            <!-- Tasks will be rendered here -->
        </div>

        <!-- Add Task Modal -->
        <div id="addTaskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">新しいタスクを追加</h2>
                    <button onclick="hideAddTaskModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="taskForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">タスク名 *</label>
                        <input type="text" id="taskName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">記入日</label>
                            <input type="date" id="entryDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">発注日</label>
                            <input type="datetime-local" id="orderDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">中間確認日</label>
                            <input type="datetime-local" id="checkDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">完了日</label>
                            <input type="datetime-local" id="completeDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                        <textarea id="remarks" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ファイル添付</label>
                        <div id="fileDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">ファイルをドラッグ&ドロップまたは</p>
                            <label class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700 mt-2">
                                ファイルを選択
                                <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx,.xls,.xlsx,.txt,.csv" id="fileInput" class="hidden">
                            </label>
                        </div>
                        <div id="selectedFiles" class="mt-2 space-y-2"></div>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" onclick="hideAddTaskModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>保存
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Task Modal -->
        <div id="editTaskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">タスクを編集</h2>
                    <button onclick="hideEditTaskModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="editTaskForm" class="space-y-4">
                    <input type="hidden" id="editTaskId">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">タスク名 *</label>
                        <input type="text" id="editTaskName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">記入日</label>
                            <input type="date" id="editEntryDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">発注日</label>
                            <input type="datetime-local" id="editOrderDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">中間確認日</label>
                            <input type="datetime-local" id="editCheckDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">完了日</label>
                            <input type="datetime-local" id="editCompleteDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">備考</label>
                        <textarea id="editRemarks" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ファイル添付</label>
                        <div id="editSelectedFiles" class="space-y-2 mb-4"></div>
                        <div id="editFileDropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors">
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600">ファイルをドラッグ&ドロップまたは</p>
                            <label class="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg cursor-pointer hover:bg-blue-700 mt-2">
                                ファイルを選択
                                <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx,.xls,.xlsx,.txt,.csv" id="editFileInput" class="hidden">
                            </label>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 pt-4">
                        <button type="button" onclick="hideEditTaskModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            キャンセル
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>更新
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- File Preview Modal -->
        <div id="filePreviewModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50 file-preview-modal">
            <div class="bg-white rounded-lg w-full max-w-4xl max-h-screen m-4 flex flex-col">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 id="previewFileName" class="text-lg font-semibold text-gray-800"></h3>
                    <div class="flex gap-2">
                        <button onclick="downloadPreviewFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-download mr-1"></i>ダウンロード
                        </button>
                        <button onclick="hideFilePreview()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div id="previewContent" class="flex-1 p-4 overflow-auto">
                    <!-- Preview content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let currentFilter = 'all';
        let editingTaskId = null;
        let currentPreviewFile = null;
        let zoomLevel = 1;
        let isDragging = false;
        let startX = 0;
        let startY = 0;
        let translateX = 0;
        let translateY = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks();
            renderTasks();
            setupEventListeners();
            setupNotifications();
            
            // Set default entry date to today
            document.getElementById('entryDate').valueAsDate = new Date();
        });

        function setupEventListeners() {
            // File drop zones
            setupFileDropZone('fileDropZone', 'fileInput', 'selectedFiles');
            setupFileDropZone('editFileDropZone', 'editFileInput', 'editSelectedFiles');
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredTasks = tasks.filter(task => 
                    task.name.toLowerCase().includes(searchTerm) ||
                    task.remarks.toLowerCase().includes(searchTerm)
                );
                renderFilteredTasks(filteredTasks);
            });

            // Form submissions
            document.getElementById('taskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                addTask();
            });

            document.getElementById('editTaskForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateTask();
            });
        }

        function setupFileDropZone(dropZoneId, fileInputId, selectedFilesId) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const selectedFiles = document.getElementById(selectedFilesId);

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                const files = Array.from(e.dataTransfer.files);
                handleFileSelection(files, selectedFilesId);
            });

            fileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                handleFileSelection(files, selectedFilesId);
            });
        }

        function handleFileSelection(files, containerId) {
            const container = document.getElementById(containerId);
            
            files.forEach(file => {
                if (file.size > 50 * 1024 * 1024) { // 50MB limit
                    alert(`ファイル "${file.name}" は50MBを超えています。`);
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result
                    };

                    const fileElement = createFileElement(fileData, containerId);
                    container.appendChild(fileElement);
                };
                reader.readAsDataURL(file);
            });
        }

        function createFileElement(fileData, containerId) {
            const div = document.createElement('div');
            div.className = 'file-item flex items-center justify-between p-3 border border-gray-200 rounded-lg bg-gray-50';
            div.dataset.fileId = fileData.id;

            const fileIcon = getFileIcon(fileData.type);
            const fileSize = formatFileSize(fileData.size);

            div.innerHTML = `
                <div class="flex items-center cursor-pointer" onclick="previewFile('${fileData.id}', '${containerId}')">
                    <i class="${fileIcon} text-2xl mr-3"></i>
                    <div>
                        <div class="font-medium text-gray-800">${fileData.name}</div>
                        <div class="text-sm text-gray-500">${fileSize}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="previewFile('${fileData.id}', '${containerId}')" class="text-blue-600 hover:text-blue-800" title="プレビュー">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button onclick="downloadFile('${fileData.id}', '${containerId}')" class="text-green-600 hover:text-green-800" title="ダウンロード">
                        <i class="fas fa-download"></i>
                    </button>
                    <button onclick="removeFile('${fileData.id}', '${containerId}')" class="text-red-600 hover:text-red-800" title="削除">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            // Store file data
            div._fileData = fileData;

            return div;
        }

        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return 'fas fa-image text-green-600';
            if (fileType === 'application/pdf') return 'fas fa-file-pdf text-red-600';
            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel text-green-600';
            if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word text-blue-600';
            if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'fas fa-file-powerpoint text-orange-600';
            if (fileType.startsWith('text/')) return 'fas fa-file-alt text-gray-600';
            return 'fas fa-file text-gray-600';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function previewFile(fileId, containerId) {
            const container = document.getElementById(containerId);
            const fileElement = container.querySelector(`[data-file-id="${fileId}"]`);
            if (!fileElement || !fileElement._fileData) return;

            const fileData = fileElement._fileData;
            currentPreviewFile = fileData;
            
            document.getElementById('previewFileName').textContent = fileData.name;
            const previewContent = document.getElementById('previewContent');
            
            // Reset zoom and position
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            
            if (fileData.type.startsWith('image/')) {
                previewContent.innerHTML = `
                    <div class="image-container relative">
                        <div class="zoom-controls">
                            <button onclick="zoomIn()" class="bg-gray-800 text-white p-2 rounded mr-1">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="zoomOut()" class="bg-gray-800 text-white p-2 rounded mr-1">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="resetZoom()" class="bg-gray-800 text-white p-2 rounded">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                        <img id="zoomableImage" class="zoomable-image max-w-full h-auto mx-auto" src="${fileData.data}" alt="${fileData.name}">
                    </div>
                `;
                setupImageZoom();
            } else if (fileData.type === 'application/pdf') {
                // Simple PDF display using iframe
                previewContent.innerHTML = `
                    <div class="text-center">
                        <div class="mb-4">
                            <p class="text-gray-600 mb-4">PDFファイルをプレビューしています</p>
                            <button onclick="downloadPreviewFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mr-2">
                                <i class="fas fa-download mr-2"></i>ダウンロード
                            </button>
                            <button onclick="openPDFInNewTab()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-external-link-alt mr-2"></i>新しいタブで開く
                            </button>
                        </div>
                        <iframe src="${fileData.data}" class="w-full h-96 border border-gray-300 rounded" title="${fileData.name}"></iframe>
                    </div>
                `;
            } else if (fileData.type.startsWith('text/')) {
                // For text files, extract and display content
                fetch(fileData.data)
                    .then(response => response.text())
                    .then(text => {
                        previewContent.innerHTML = `
                            <div class="bg-gray-100 p-4 rounded-lg">
                                <pre class="whitespace-pre-wrap text-sm text-gray-800">${escapeHtml(text)}</pre>
                            </div>
                        `;
                    })
                    .catch(() => {
                        previewContent.innerHTML = `
                            <div class="text-center text-gray-600">
                                <i class="fas fa-file-alt text-4xl mb-4"></i>
                                <p>テキストファイルの内容を表示できません</p>
                                <button onclick="downloadPreviewFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mt-4">
                                    <i class="fas fa-download mr-2"></i>ダウンロード
                                </button>
                            </div>
                        `;
                    });
            } else {
                // For other file types, show file info and download option
                previewContent.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="${getFileIcon(fileData.type)} text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">${fileData.name}</h3>
                        <p class="mb-2">サイズ: ${formatFileSize(fileData.size)}</p>
                        <p class="mb-4">種類: ${fileData.type}</p>
                        <p class="mb-4">このファイル形式はプレビューできません</p>
                        <button onclick="downloadPreviewFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-download mr-2"></i>ダウンロード
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('filePreviewModal').classList.remove('hidden');
        }

        function setupImageZoom() {
            const image = document.getElementById('zoomableImage');
            if (!image) return;

            image.addEventListener('mousedown', startDrag);
            image.addEventListener('mousemove', drag);
            image.addEventListener('mouseup', endDrag);
            image.addEventListener('mouseleave', endDrag);
            
            // Touch events for mobile
            image.addEventListener('touchstart', startDrag);
            image.addEventListener('touchmove', drag);
            image.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            if (zoomLevel <= 1) return;
            
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            startX = clientX - translateX;
            startY = clientY - translateY;
            
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || zoomLevel <= 1) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            translateX = clientX - startX;
            translateY = clientY - startY;
            
            updateImageTransform();
            e.preventDefault();
        }

        function endDrag() {
            isDragging = false;
        }

        function zoomIn() {
            zoomLevel = Math.min(zoomLevel * 1.2, 5);
            updateImageTransform();
        }

        function zoomOut() {
            zoomLevel = Math.max(zoomLevel / 1.2, 0.5);
            if (zoomLevel <= 1) {
                translateX = 0;
                translateY = 0;
            }
            updateImageTransform();
        }

        function resetZoom() {
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
        }

        function updateImageTransform() {
            const image = document.getElementById('zoomableImage');
            if (image) {
                image.style.transform = `scale(${zoomLevel}) translate(${translateX / zoomLevel}px, ${translateY / zoomLevel}px)`;
            }
        }

        function openPDFInNewTab() {
            if (currentPreviewFile && currentPreviewFile.type === 'application/pdf') {
                const newWindow = window.open();
                newWindow.document.write(`
                    <html>
                        <head><title>${currentPreviewFile.name}</title></head>
                        <body style="margin:0;">
                            <iframe src="${currentPreviewFile.data}" width="100%" height="100%" style="border:none;"></iframe>
                        </body>
                    </html>
                `);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadFile(fileId, containerId) {
            const container = document.getElementById(containerId);
            const fileElement = container.querySelector(`[data-file-id="${fileId}"]`);
            if (!fileElement || !fileElement._fileData) return;

            const fileData = fileElement._fileData;
            downloadFileData(fileData);
        }

        function downloadPreviewFile() {
            if (currentPreviewFile) {
                downloadFileData(currentPreviewFile);
            }
        }

        function downloadFileData(fileData) {
            const link = document.createElement('a');
            link.href = fileData.data;
            link.download = fileData.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function removeFile(fileId, containerId) {
            if (confirm('このファイルを削除しますか？')) {
                const container = document.getElementById(containerId);
                const fileElement = container.querySelector(`[data-file-id="${fileId}"]`);
                if (fileElement) {
                    fileElement.remove();
                }
            }
        }

        function hideFilePreview() {
            document.getElementById('filePreviewModal').classList.add('hidden');
            currentPreviewFile = null;
        }

        function showAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('hidden');
        }

        function hideAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('hidden');
            document.getElementById('taskForm').reset();
            document.getElementById('selectedFiles').innerHTML = '';
            document.getElementById('entryDate').valueAsDate = new Date();
        }

        function showEditTaskModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('editTaskName').value = task.name;
            document.getElementById('editEntryDate').value = task.entryDate;
            document.getElementById('editOrderDate').value = task.orderDate;
            document.getElementById('editCheckDate').value = task.checkDate;
            document.getElementById('editCompleteDate').value = task.completeDate;
            document.getElementById('editRemarks').value = task.remarks;

            // Display existing files
            const container = document.getElementById('editSelectedFiles');
            container.innerHTML = '';
            
            if (task.files && task.files.length > 0) {
                task.files.forEach(file => {
                    const fileElement = createFileElement(file, 'editSelectedFiles');
                    container.appendChild(fileElement);
                });
            }

            document.getElementById('editTaskModal').classList.remove('hidden');
        }

        function hideEditTaskModal() {
            document.getElementById('editTaskModal').classList.add('hidden');
            document.getElementById('editTaskForm').reset();
            document.getElementById('editSelectedFiles').innerHTML = '';
            editingTaskId = null;
        }

        function addTask() {
            const task = {
                id: Date.now(),
                name: document.getElementById('taskName').value,
                entryDate: document.getElementById('entryDate').value,
                orderDate: document.getElementById('orderDate').value,
                checkDate: document.getElementById('checkDate').value,
                completeDate: document.getElementById('completeDate').value,
                remarks: document.getElementById('remarks').value,
                completed: false,
                files: getFilesFromContainer('selectedFiles'),
                createdAt: new Date().toISOString()
            };

            tasks.push(task);
            saveTasks();
            renderTasks();
            hideAddTaskModal();
            
            // Set up notifications for this task
            setupTaskNotifications(task);
        }

        function updateTask() {
            const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
            if (taskIndex === -1) return;

            const task = tasks[taskIndex];
            task.name = document.getElementById('editTaskName').value;
            task.entryDate = document.getElementById('editEntryDate').value;
            task.orderDate = document.getElementById('editOrderDate').value;
            task.checkDate = document.getElementById('editCheckDate').value;
            task.completeDate = document.getElementById('editCompleteDate').value;
            task.remarks = document.getElementById('editRemarks').value;
            task.files = getFilesFromContainer('editSelectedFiles');

            tasks[taskIndex] = task;
            saveTasks();
            renderTasks();
            hideEditTaskModal();
            
            // Update notifications for this task
            setupTaskNotifications(task);
        }

        function getFilesFromContainer(containerId) {
            const container = document.getElementById(containerId);
            const fileElements = container.querySelectorAll('.file-item');
            return Array.from(fileElements).map(element => element._fileData).filter(Boolean);
        }

        function deleteTask(taskId) {
            if (confirm('このタスクを削除しますか？')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveTasks();
                renderTasks();
            }
        }

        function duplicateTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const newTask = {
                ...task,
                id: Date.now(),
                name: task.name + ' (コピー)',
                completed: false,
                createdAt: new Date().toISOString()
            };

            tasks.push(newTask);
            saveTasks();
            renderTasks();
            setupTaskNotifications(newTask);
        }

        function toggleTaskCompletion(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                renderTasks();
            }
        }

        function filterTasks(filter) {
            currentFilter = filter;
            
            // Update filter buttons
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.className = 'px-4 py-2 rounded bg-gray-300 text-gray-700';
            });
            document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1)).className = 'px-4 py-2 rounded bg-blue-600 text-white';
            
            renderTasks();
        }

        function renderTasks() {
            let filteredTasks = tasks;
            
            if (currentFilter === 'pending') {
                filteredTasks = tasks.filter(task => !task.completed);
            } else if (currentFilter === 'completed') {
                filteredTasks = tasks.filter(task => task.completed);
            }
            
            renderFilteredTasks(filteredTasks);
        }

        function renderFilteredTasks(tasksToRender) {
            const tasksList = document.getElementById('tasksList');
            
            if (tasksToRender.length === 0) {
                tasksList.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-8 text-center">
                        <i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 text-lg">タスクがありません</p>
                        <button onclick="showAddTaskModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg mt-4">
                            <i class="fas fa-plus mr-2"></i>最初のタスクを追加
                        </button>
                    </div>
                `;
                return;
            }

            tasksList.innerHTML = tasksToRender.map(task => `
                <div class="task-item bg-white rounded-lg shadow-md p-6 ${task.completed ? 'opacity-75' : ''}">
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center mb-3">
                                <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTaskCompletion(${task.id})" class="mr-3 w-5 h-5 text-blue-600">
                                <h3 class="text-xl font-semibold text-gray-800 cursor-pointer editable ${task.completed ? 'line-through' : ''}" onclick="showEditTaskModal(${task.id})">${task.name}</h3>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-600">記入日</label>
                                    <div class="text-gray-800">${formatDate(task.entryDate) || '未設定'}</div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">発注日</label>
                                    <div class="text-gray-800">${formatDateTime(task.orderDate) || '未設定'}</div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">中間確認日</label>
                                    <div class="text-gray-800">${formatDateTime(task.checkDate) || '未設定'}</div>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-600">完了日</label>
                                    <div class="text-gray-800">${formatDateTime(task.completeDate) || '未設定'}</div>
                                </div>
                            </div>
                            
                            ${task.remarks ? `
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-600">備考</label>
                                    <div class="text-gray-800 bg-gray-50 p-2 rounded">${task.remarks}</div>
                                </div>
                            ` : ''}
                            
                            ${task.files && task.files.length > 0 ? `
                                <div class="mb-4">
                                    <label class="text-sm font-medium text-gray-600 mb-2 block">添付ファイル (${task.files.length})</label>
                                    <div class="flex flex-wrap gap-2">
                                        ${task.files.map(file => `
                                            <button onclick="previewTaskFile('${task.id}', '${file.id}')" class="file-item flex items-center p-2 bg-gray-50 hover:bg-gray-100 rounded border text-sm">
                                                <i class="${getFileIcon(file.type)} mr-2"></i>
                                                <span class="truncate max-w-32">${file.name}</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex flex-col lg:flex-row gap-2 mt-4 lg:mt-0 lg:ml-4">
                            <div class="flex flex-wrap gap-2">
                                ${task.orderDate ? `
                                    <button onclick="addToCalendar('${task.id}', 'order')" class="calendar-button text-white px-3 py-1 rounded text-sm">
                                        📅 発注日
                                    </button>
                                ` : ''}
                                ${task.checkDate ? `
                                    <button onclick="addToCalendar('${task.id}', 'check')" class="calendar-button text-white px-3 py-1 rounded text-sm">
                                        📅 確認日
                                    </button>
                                ` : ''}
                                ${task.completeDate ? `
                                    <button onclick="addToCalendar('${task.id}', 'complete')" class="calendar-button text-white px-3 py-1 rounded text-sm">
                                        📅 完了日
                                    </button>
                                ` : ''}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="showEditTaskModal(${task.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="duplicateTask(${task.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="deleteTask(${task.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function previewTaskFile(taskId, fileId) {
            const task = tasks.find(t => t.id == taskId);
            if (!task || !task.files) return;
            
            const file = task.files.find(f => f.id == fileId);
            if (!file) return;
            
            currentPreviewFile = file;
            
            document.getElementById('previewFileName').textContent = file.name;
            const previewContent = document.getElementById('previewContent');
            
            // Reset zoom and position
            zoomLevel = 1;
            translateX = 0;
            translateY = 0;
            
            if (file.type.startsWith('image/')) {
                previewContent.innerHTML = `
                    <div class="image-container relative">
                        <div class="zoom-controls">
                            <button onclick="zoomIn()" class="bg-gray-800 text-white p-2 rounded mr-1">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button onclick="zoomOut()" class="bg-gray-800 text-white p-2 rounded mr-1">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button onclick="resetZoom()" class="bg-gray-800 text-white p-2 rounded">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                        <img id="zoomableImage" class="zoomable-image max-w-full h-auto mx-auto" src="${file.data}" alt="${file.name}">
                    </div>
                `;
                setupImageZoom();
            } else if (file.type === 'application/pdf') {
                previewContent.innerHTML = `
                    <div class="text-center">
                        <div class="mb-4">
                            <p class="text-gray-600 mb-4">PDFファイルをプレビューしています</p>
                            <button onclick="downloadPreviewFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg mr-2">
                                <i class="fas fa-download mr-2"></i>ダウンロード
                            </button>
                            <button onclick="openPDFInNewTab()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-external-link-alt mr-2"></i>新しいタブで開く
                            </button>
                        </div>
                        <iframe src="${file.data}" class="w-full h-96 border border-gray-300 rounded" title="${file.name}"></iframe>
                    </div>
                `;
            } else {
                previewContent.innerHTML = `
                    <div class="text-center text-gray-600">
                        <i class="${getFileIcon(file.type)} text-6xl mb-4"></i>
                        <h3 class="text-xl font-semibold mb-2">${file.name}</h3>
                        <p class="mb-2">サイズ: ${formatFileSize(file.size)}</p>
                        <p class="mb-4">種類: ${file.type}</p>
                        <p class="mb-4">このファイル形式はプレビューできません</p>
                        <button onclick="downloadPreviewFile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-download mr-2"></i>ダウンロード
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('filePreviewModal').classList.remove('hidden');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP');
        }

        function formatDateTime(dateTimeString) {
            if (!dateTimeString) return '';
            const date = new Date(dateTimeString);
            return date.toLocaleDateString('ja-JP') + ' ' + date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        }

        function addToCalendar(taskId, dateType) {
            const task = tasks.find(t => t.id == taskId);
            if (!task) return;

            let date, title;
            
            switch(dateType) {
                case 'order':
                    date = new Date(task.orderDate);
                    title = `【発注】${task.name}`;
                    break;
                case 'check':
                    date = new Date(task.checkDate);
                    title = `【中間確認】${task.name}`;
                    break;
                case 'complete':
                    date = new Date(task.completeDate);
                    title = `【完了】${task.name}`;
                    break;
            }

            if (!date || isNaN(date.getTime())) {
                alert('有効な日付が設定されていません');
                return;
            }

            // Google Calendar URL
            const startDate = date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const endDate = new Date(date.getTime() + 60*60*1000).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            
            const details = encodeURIComponent(task.remarks || '');
            const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startDate}/${endDate}&details=${details}`;
            
            window.open(googleUrl, '_blank');
        }

        function exportData() {
            const dataStr = JSON.stringify({tasks: tasks}, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `tasks_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let content = e.target.result;
                    
                    // Handle different file formats
                    if (file.name.endsWith('.txt') || file.type === 'text/plain') {
                        // Try to parse as JSON
                        content = content.trim();
                        if (content.startsWith('{') || content.startsWith('[')) {
                            content = JSON.parse(content);
                        } else {
                            throw new Error('Invalid format');
                        }
                    } else {
                        content = JSON.parse(content);
                    }
                    
                    if (content.tasks && Array.isArray(content.tasks)) {
                        if (confirm(`${content.tasks.length}個のタスクをインポートしますか？\n現在のデータは上書きされます。`)) {
                            tasks = content.tasks;
                            saveTasks();
                            renderTasks();
                            
                            // Setup notifications for imported tasks
                            tasks.forEach(task => setupTaskNotifications(task));
                            
                            alert('インポートが完了しました！');
                        }
                    } else {
                        throw new Error('Invalid data structure');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('ファイル形式が正しくありません。有効なJSONファイルを選択してください。');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }

        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function loadTasks() {
            const saved = localStorage.getItem('tasks');
            if (saved) {
                try {
                    tasks = JSON.parse(saved);
                    // Setup notifications for loaded tasks
                    tasks.forEach(task => setupTaskNotifications(task));
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    tasks = [];
                }
            }
        }

        // Notification functionality
        function setupNotifications() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    document.getElementById('notificationBtn').style.display = 'none';
                } else if (Notification.permission === 'denied') {
                    document.getElementById('notificationBtn').textContent = '通知が無効になっています';
                    document.getElementById('notificationBtn').disabled = true;
                }
            } else {
                document.getElementById('notificationBtn').style.display = 'none';
            }
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        document.getElementById('notificationBtn').style.display = 'none';
                        alert('通知が有効になりました！');
                        
                        // Setup notifications for existing tasks
                        tasks.forEach(task => setupTaskNotifications(task));
                    } else {
                        alert('通知の許可が拒否されました。ブラウザの設定から手動で有効にしてください。');
                    }
                });
            }
        }

        function setupTaskNotifications(task) {
            if (Notification.permission !== 'granted') return;
            
            const now = new Date();
            const notifications = [];
            
            // Order date notifications
            if (task.orderDate && !task.completed) {
                const orderDate = new Date(task.orderDate);
                if (orderDate > now) {
                    notifications.push({
                        date: new Date(orderDate.getTime() - 60*60*1000), // 1 hour before
                        message: `【発注日1時間前】${task.name} - 忘れていませんか？`
                    });
                    notifications.push({
                        date: new Date(orderDate.getTime() - 30*60*1000), // 30 minutes before
                        message: `【発注日30分前】${task.name} - 忘れていませんか？`
                    });
                    notifications.push({
                        date: orderDate,
                        message: `【発注日】${task.name} - 忘れていませんか？`
                    });
                }
            }
            
            // Check date notifications
            if (task.checkDate && !task.completed) {
                const checkDate = new Date(task.checkDate);
                if (checkDate > now) {
                    notifications.push({
                        date: new Date(checkDate.getTime() - 60*60*1000),
                        message: `【中間確認1時間前】${task.name} - 忘れていませんか？`
                    });
                    notifications.push({
                        date: new Date(checkDate.getTime() - 30*60*1000),
                        message: `【中間確認30分前】${task.name} - 忘れていませんか？`
                    });
                    notifications.push({
                        date: checkDate,
                        message: `【中間確認日】${task.name} - 忘れていませんか？`
                    });
                }
            }
            
            // Complete date notifications
            if (task.completeDate && !task.completed) {
                const completeDate = new Date(task.completeDate);
                if (completeDate > now) {
                    notifications.push({
                        date: new Date(completeDate.getTime() - 60*60*1000),
                        message: `【完了予定1時間前】${task.name} - 忘れていませんか？`
                    });
                    notifications.push({
                        date: new Date(completeDate.getTime() - 30*60*1000),
                        message: `【完了予定30分前】${task.name} - 忘れていませんか？`
                    });
                    notifications.push({
                        date: completeDate,
                        message: `【完了予定日】${task.name} - 忘れていませんか？`
                    });
                }
            }
            
            // Schedule notifications
            notifications.forEach(notification => {
                const delay = notification.date.getTime() - now.getTime();
                if (delay > 0) {
                    setTimeout(() => {
                        // Check if task is still not completed
                        const currentTask = tasks.find(t => t.id === task.id);
                        if (currentTask && !currentTask.completed) {
                            new Notification('タスク管理アプリ', {
                                body: notification.message,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" fill="%234285f4"/><text x="32" y="36" font-family="Arial" font-size="20" fill="white" text-anchor="middle">📋</text></svg>'
                            });
                        }
                    }, delay);
                }
            });
        }

        // Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                const swScript = `
                    const CACHE_NAME = 'task-manager-v1';
                    const urlsToCache = [];
                    
                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });
                    
                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;
                
                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
